// Generated by CoffeeScript 1.6.2
var Parser, express, fs;

fs = require('fs');

express = require('express');

module.exports.namespace = 'express';

Parser = require('./Parser');

module.exports.deviceCapture = function() {
  return function(req, res, next) {
    var parser;

    parser = new Parser(req);
    req.device = parser.getDevice();
    return typeof next === "function" ? next() : void 0;
  };
};

express.application.enableDeviceRouting = function() {
  var app, ext, root;

  app = this.app || this;
  root = app.get('views');
  ext = app.get('view engine');
  return app.use(function(req, res, next) {
    var _render;

    _render = res.render.bind(res);
    res.render = function(name, options, fn) {
      var deviceTemplate, parser;

      if (req.device == null) {
        parser = new Parser(req);
        req.device = parser.getDevice();
      }
      deviceTemplate = "" + req.device + "/" + name;
      return fs.exists("" + root + "/" + deviceTemplate + "." + ext, function(exists) {
        if (exists) {
          return _render(deviceTemplate, options, fn);
        } else {
          return _render(name, options, fn);
        }
      });
    };
    return typeof next === "function" ? next() : void 0;
  });
};
